<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚¿ã‚«ãƒ ãƒ‡ã‚³ã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"M PLUS Rounded 1c"', 'sans-serif'],
                    },
                    colors: {
                        pastel: {
                            yellow: '#fef3c7', // bg-yellow-100 equivalent
                            main: '#fcd34d',   // yellow-300
                            dark: '#d97706',   // yellow-600
                            pink: '#f9a8d4',
                            blue: '#93c5fd',
                            green: '#86efac',
                        }
                    },
                    animation: {
                        'bounce-slight': 'bounceSlight 2s infinite',
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        bounceSlight: {
                            '0%, 100%': { transform: 'translateY(-3%)' },
                            '50%': { transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        popIn: {
                            '0%': { opacity: '0', transform: 'scale(0.8)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            /* ãƒ‘ã‚¹ãƒ†ãƒ«ã‚«ãƒ©ãƒ¼ã®èƒŒæ™¯ãƒ‘ã‚¿ãƒ¼ãƒ³ */
            background-color: #fffbeb;
            background-image: radial-gradient(#fde68a 15%, transparent 16%), radial-gradient(#fde68a 15%, transparent 16%);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
        }

        /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ - 16:9 */
        #canvas-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            aspect-ratio: 16 / 9;
            position: relative;
            overflow: hidden;
            border: 6px solid #fcd34d; /* ãƒ‘ã‚¹ãƒ†ãƒ«ã‚¤ã‚¨ãƒ­ãƒ¼ã®æ  */
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(251, 191, 36, 0.4);
            background-color: #ffffff;
            /* é€æ˜èƒŒæ™¯ã‚’è¡¨ã™å¸‚æ¾æ¨¡æ§˜ï¼ˆè–„ãï¼‰ */
            background-image: 
                linear-gradient(45deg, #fff 25%, #fefce8 25%, #fefce8 75%, #fff 75%, #fff),
                linear-gradient(45deg, #fff 25%, #fefce8 25%, #fefce8 75%, #fff 75%, #fff);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }
        #photoCanvas {
            display: block;
            width: 100%;
            height: 100%;
            touch-action: none;
            user-select: none;
            cursor: grab;
        }
        #photoCanvas:active {
            cursor: grabbing;
        }
        
        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆå¯æ„›ãï¼‰ */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #fcd34d;
            border: 3px solid #fff;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #fef3c7;
            border-radius: 4px;
            border: 1px solid #fde68a;
        }
        
        /* ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .btn-hover-pop:hover {
            transform: scale(1.05);
        }
        .btn-hover-pop:active {
            transform: scale(0.95);
        }

        /* ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ã‚¿ã‚¤ãƒ«ä¸Šæ›¸ã */
        .tab-btn.active {
            background-color: #fcd34d !important;
            color: #78350f !important; /* amber-900 */
            border: none !important;
            box-shadow: 0 4px 6px -1px rgba(251, 191, 36, 0.3);
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="min-h-screen py-8 text-amber-900">

    <div id="trimming-modal" class="fixed inset-0 z-50 bg-amber-100 bg-opacity-90 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-2xl p-6 animate-pop-in flex flex-col max-h-[90vh] border-4 border-yellow-200">
            <h2 class="text-2xl font-bold text-amber-500 mb-4 flex items-center justify-center gap-2">
                âœ‚ï¸ ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’èª¿æ•´ (16:9)
            </h2>
            
            <div class="flex-1 min-h-0 flex items-center justify-center bg-gray-50 rounded-2xl overflow-hidden relative mb-6 border-2 border-dashed border-gray-300">
                <canvas id="trimming-canvas" class="cursor-move"></canvas>
            </div>

            <div class="space-y-6 bg-yellow-50 p-4 rounded-2xl">
                <div class="flex items-center gap-4">
                    <span class="text-sm font-bold text-amber-600 w-12">ã‚ºãƒ¼ãƒ </span>
                    <span class="text-xl">ğŸ”</span>
                    <input type="range" id="trim-scale-slider" min="0.1" max="3.0" step="0.01" value="1.0">
                </div>
                
                <div class="flex gap-4">
                    <button onclick="cancelTrimming()" class="flex-1 py-3 px-4 rounded-xl border-2 border-gray-200 font-bold text-gray-500 hover:bg-gray-50 transition">
                        ã‚„ã‚ã‚‹
                    </button>
                    <button onclick="applyTrimming()" class="flex-1 py-3 px-4 rounded-xl bg-gradient-to-r from-yellow-400 to-orange-400 font-bold text-white hover:from-yellow-500 hover:to-orange-500 shadow-md transition btn-hover-pop">
                        æ±ºå®šï¼
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4">
        <header class="text-center mb-8 relative">
            <div class="inline-block relative">
                <h1 class="text-4xl md:text-5xl font-extrabold text-yellow-500 tracking-tight drop-shadow-sm mb-2" style="text-shadow: 2px 2px 0px #fff;">
                    ğŸ¨ ã‚¹ã‚¿ã‚«ãƒ ãƒ‡ã‚³ã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼ ğŸ‰
                </h1>
                <span class="absolute -top-6 -right-6 text-4xl animate-bounce-slight">âœ¨</span>
            </div>
            <p class="text-amber-600/80 font-bold mt-2 text-lg">ãƒ•ãƒ¬ãƒ¼ãƒ ã‚„ã‚¹ã‚¿ãƒ³ãƒ—ã§ã‚‚ã£ã¨ç››ã‚Šä¸Šã’ã‚ˆã†ï¼</p>
        </header>

        <div id="canvas-container" class="mb-8">
            <canvas id="photoCanvas" width="800" height="450"></canvas>
            
            <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 p-6 pointer-events-none bg-white/50 backdrop-blur-sm">
                <div class="w-24 h-24 bg-yellow-100 rounded-full flex items-center justify-center mb-4 border-4 border-yellow-200 animate-pulse">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 16m-2-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
                <p class="text-xl font-bold text-amber-400 drop-shadow-sm">å†™çœŸã‚’ãˆã‚‰ã‚“ã§ã­ï¼</p>
            </div>
        </div>

        <div id="adjustment-panel" class="hidden bg-white/90 backdrop-blur p-4 rounded-3xl shadow-lg border-2 border-yellow-200 mb-6 animate-pop-in">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-amber-500 font-bold flex items-center gap-2">
                    <span class="bg-amber-100 p-1 rounded-md">ğŸ› ï¸</span> èª¿æ•´
                </h3>
                <button onclick="deleteSelectedObject()" class="text-white font-bold text-xs px-4 py-2 bg-red-400 rounded-full hover:bg-red-500 transition shadow-sm btn-hover-pop">å‰Šé™¤ã™ã‚‹ ğŸ—‘ï¸</button>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 bg-amber-50 p-4 rounded-2xl">
                <div class="flex items-center gap-4">
                    <span class="text-sm font-bold text-amber-700 w-12">å¤§ãã•</span>
                    <input type="range" id="scale-slider" min="0.2" max="3.0" step="0.05" value="1.0" oninput="updateObjectProperty('scale', this.value)">
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm font-bold text-amber-700 w-12">ã‹ãŸã‚€ã</span>
                    <input type="range" id="rotation-slider" min="-180" max="180" step="1" value="0" oninput="updateObjectProperty('rotation', this.value)">
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-xl overflow-hidden border-2 border-yellow-100">
            <div class="flex overflow-x-auto bg-amber-50 p-3 gap-2">
                <button onclick="switchTab('upload')" class="tab-btn active flex-1 py-3 px-4 rounded-2xl font-bold text-amber-700/60 hover:bg-amber-100 focus:outline-none whitespace-nowrap transition-all duration-200" data-tab="upload">ğŸ“ å†™çœŸ</button>
                <button onclick="switchTab('frame')" class="tab-btn flex-1 py-3 px-4 rounded-2xl font-bold text-amber-700/60 hover:bg-amber-100 focus:outline-none whitespace-nowrap transition-all duration-200" data-tab="frame">ğŸ–¼ï¸ ãƒ•ãƒ¬ãƒ¼ãƒ </button>
                <button onclick="switchTab('sticker')" class="tab-btn flex-1 py-3 px-4 rounded-2xl font-bold text-amber-700/60 hover:bg-amber-100 focus:outline-none whitespace-nowrap transition-all duration-200" data-tab="sticker">âœ¨ ã‚¹ã‚¿ãƒ³ãƒ—</button>
                <button onclick="switchTab('text')" class="tab-btn flex-1 py-3 px-4 rounded-2xl font-bold text-amber-700/60 hover:bg-amber-100 focus:outline-none whitespace-nowrap transition-all duration-200" data-tab="text">âœï¸ ã‚‚ã˜</button>
            </div>

            <div class="p-6 min-h-[250px] bg-white">
                <div id="tab-upload" class="tab-content block animate-fade-in">
                    <div class="flex flex-col items-center justify-center border-4 border-dashed border-yellow-200 rounded-3xl p-10 bg-yellow-50 hover:bg-yellow-100 transition relative group cursor-pointer">
                        <input type="file" id="photoInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <div class="bg-white p-4 rounded-full shadow-md mb-4 group-hover:scale-110 transition-transform duration-300">
                            <svg class="w-12 h-12 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        </div>
                        <span class="text-amber-500 font-bold text-lg">ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’é¸æŠ</span>
                        <p class="text-amber-400 text-sm mt-2">ã‚«ãƒ¡ãƒ©ãƒ­ãƒ¼ãƒ«ã‹ã‚‰é¸ã‚“ã§ã­</p>
                    </div>
                </div>

                <div id="tab-frame" class="tab-content hidden animate-fade-in">
                    <div class="mb-4 p-4 bg-blue-50 rounded-2xl border border-blue-100">
                        <label class="block text-blue-600 font-bold mb-2 text-sm flex items-center gap-2">
                            <span>ğŸ“</span> ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½¿ã†
                        </label>
                        <input type="file" id="customFrameInput" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-blue-100 file:text-blue-600 hover:file:bg-blue-200 cursor-pointer"/>
                        <p class="text-xs text-blue-400 mt-2 pl-2">â€»çœŸã‚“ä¸­ãŒé€æ˜ãªPNGç”»åƒã‚’ä½¿ã£ã¦ã­</p>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4" id="frame-grid">
                        </div>
                </div>

                <div id="tab-sticker" class="tab-content hidden animate-fade-in">
                    <div class="mb-6 p-4 bg-pink-50 rounded-2xl border border-pink-100">
                        <label class="block text-pink-600 font-bold mb-2 text-sm flex items-center gap-2">
                            <span>ğŸ“</span> ç”»åƒã‚’ã‚¹ã‚¿ãƒ³ãƒ—ã«ã™ã‚‹
                        </label>
                        <input type="file" id="customStickerInput" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-pink-100 file:text-pink-600 hover:file:bg-pink-200 cursor-pointer"/>
                    </div>

                    <!-- å¹ãå‡ºã—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="mb-6">
                        <h4 class="text-sm font-bold text-amber-500 mb-3 ml-1 flex items-center gap-2">
                            <span>ğŸ’¬</span> å¹ãå‡ºã—
                        </h4>
                        <div class="grid grid-cols-4 gap-3 mb-4" id="fukidashi-shapes">
                            <!-- å¹ãå‡ºã—ã®å½¢ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
                        </div>
                        <!-- è‰²é¸æŠUIï¼ˆå¹ãå‡ºã—ã‚’é¸ã‚“ã å¾Œã«è¡¨ç¤ºï¼‰ -->
                        <div id="fukidashi-color-picker" class="hidden bg-amber-50 p-4 rounded-2xl border border-amber-100">
                            <label class="block text-amber-600 font-bold mb-2 text-sm">è‰²ã‚’é¸ã‚“ã§ã­</label>
                            <div class="flex gap-3 overflow-x-auto pb-2">
                                <button onclick="selectFukidashiColor('#ffffff')" class="w-10 h-10 rounded-full bg-white border-2 border-gray-200 flex-shrink-0 shadow-sm hover:scale-110 transition"></button>
                                <button onclick="selectFukidashiColor('#fef3c7')" class="w-10 h-10 rounded-full bg-yellow-100 flex-shrink-0 shadow-sm hover:scale-110 transition border-2 border-white"></button>
                                <button onclick="selectFukidashiColor('#fcd34d')" class="w-10 h-10 rounded-full bg-yellow-300 flex-shrink-0 shadow-sm hover:scale-110 transition border-2 border-white"></button>
                                <button onclick="selectFukidashiColor('#f472b6')" class="w-10 h-10 rounded-full bg-pink-400 flex-shrink-0 shadow-sm hover:scale-110 transition border-2 border-white"></button>
                                <button onclick="selectFukidashiColor('#93c5fd')" class="w-10 h-10 rounded-full bg-blue-300 flex-shrink-0 shadow-sm hover:scale-110 transition border-2 border-white"></button>
                                <button onclick="selectFukidashiColor('#86efac')" class="w-10 h-10 rounded-full bg-green-300 flex-shrink-0 shadow-sm hover:scale-110 transition border-2 border-white"></button>
                                <button onclick="selectFukidashiColor('#c084fc')" class="w-10 h-10 rounded-full bg-purple-300 flex-shrink-0 shadow-sm hover:scale-110 transition border-2 border-white"></button>
                                <button onclick="selectFukidashiColor('#fca5a5')" class="w-10 h-10 rounded-full bg-red-300 flex-shrink-0 shadow-sm hover:scale-110 transition border-2 border-white"></button>
                                <div class="relative w-10 h-10 rounded-full overflow-hidden flex-shrink-0 shadow-sm hover:scale-110 transition border-2 border-white bg-white">
                                    <input type="color" id="fukidashi-custom-color" class="absolute inset-0 w-[150%] h-[150%] -top-[25%] -left-[25%] p-0 border-0 cursor-pointer opacity-0 z-10" onchange="selectFukidashiColor(this.value)">
                                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-0">
                                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h4 class="text-sm font-bold text-gray-400 mb-3 ml-1">çµµæ–‡å­—ã‚¹ã‚¿ãƒ³ãƒ—</h4>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="addSticker('ğŸ’–')" class="w-14 h-14 bg-gray-50 rounded-2xl shadow-sm text-3xl hover:bg-white hover:shadow-md hover:scale-110 transition border border-gray-100">ğŸ’–</button>
                        <button onclick="addSticker('âœ¨')" class="w-14 h-14 bg-gray-50 rounded-2xl shadow-sm text-3xl hover:bg-white hover:shadow-md hover:scale-110 transition border border-gray-100">âœ¨</button>
                        <button onclick="addSticker('â­')" class="w-14 h-14 bg-gray-50 rounded-2xl shadow-sm text-3xl hover:bg-white hover:shadow-md hover:scale-110 transition border border-gray-100">â­</button>
                        <button onclick="addSticker('ğŸ‰')" class="w-14 h-14 bg-gray-50 rounded-2xl shadow-sm text-3xl hover:bg-white hover:shadow-md hover:scale-110 transition border border-gray-100">ğŸ‰</button>
                        <button onclick="addSticker('ğŸŒ¸')" class="w-14 h-14 bg-gray-50 rounded-2xl shadow-sm text-3xl hover:bg-white hover:shadow-md hover:scale-110 transition border border-gray-100">ğŸŒ¸</button>
                        <button onclick="addSticker('ğŸ€')" class="w-14 h-14 bg-gray-50 rounded-2xl shadow-sm text-3xl hover:bg-white hover:shadow-md hover:scale-110 transition border border-gray-100">ğŸ€</button>
                        <button onclick="addSticker('ğŸ‘‘')" class="w-14 h-14 bg-gray-50 rounded-2xl shadow-sm text-3xl hover:bg-white hover:shadow-md hover:scale-110 transition border border-gray-100">ğŸ‘‘</button>
                        <button onclick="addSticker('ğŸ¦‹')" class="w-14 h-14 bg-gray-50 rounded-2xl shadow-sm text-3xl hover:bg-white hover:shadow-md hover:scale-110 transition border border-gray-100">ğŸ¦‹</button>
                        <button onclick="addSticker('ğŸ±')" class="w-14 h-14 bg-gray-50 rounded-2xl shadow-sm text-3xl hover:bg-white hover:shadow-md hover:scale-110 transition border border-gray-100">ğŸ±</button>
                        <button onclick="addSticker('ğŸ¶')" class="w-14 h-14 bg-gray-50 rounded-2xl shadow-sm text-3xl hover:bg-white hover:shadow-md hover:scale-110 transition border border-gray-100">ğŸ¶</button>
                        <button onclick="addSticker('ğŸ˜')" class="w-14 h-14 bg-gray-50 rounded-2xl shadow-sm text-3xl hover:bg-white hover:shadow-md hover:scale-110 transition border border-gray-100">ğŸ˜</button>
                        <button onclick="addSticker('ğŸ‚')" class="w-14 h-14 bg-gray-50 rounded-2xl shadow-sm text-3xl hover:bg-white hover:shadow-md hover:scale-110 transition border border-gray-100">ğŸ‚</button>
                    </div>
                </div>

                <div id="tab-text" class="tab-content hidden animate-fade-in">
                    <div class="space-y-6">
                        <div>
                            <label class="text-xs text-amber-500 font-bold block mb-2 pl-1">ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›</label>
                            <input type="text" id="text-input" placeholder="ã“ã“ã«å…¥åŠ›ã—ã¦ã­" class="w-full p-4 border-2 border-amber-100 rounded-2xl focus:outline-none focus:border-amber-400 focus:bg-amber-50 transition text-lg font-bold text-gray-700">
                        </div>
                        
                        <div class="flex-1">
                            <label class="text-xs text-amber-500 font-bold block mb-2 pl-1">ã‚«ãƒ©ãƒ¼ã‚’ãˆã‚‰ã¶</label>
                            <div class="flex gap-3 overflow-x-auto pb-4 scrollbar-hide">
                                <button onclick="setTextColor('#000000')" class="w-10 h-10 rounded-full bg-black border-2 border-gray-200 flex-shrink-0 shadow-sm hover:scale-110 transition"></button>
                                <button onclick="setTextColor('#ffffff')" class="w-10 h-10 rounded-full bg-white border-2 border-gray-200 flex-shrink-0 shadow-sm hover:scale-110 transition"></button>
                                <button onclick="setTextColor('#ef4444')" class="w-10 h-10 rounded-full bg-red-400 flex-shrink-0 shadow-sm hover:scale-110 transition border-2 border-white"></button>
                                <button onclick="setTextColor('#f472b6')" class="w-10 h-10 rounded-full bg-pink-400 flex-shrink-0 shadow-sm hover:scale-110 transition border-2 border-white"></button>
                                <button onclick="setTextColor('#fbbf24')" class="w-10 h-10 rounded-full bg-amber-400 flex-shrink-0 shadow-sm hover:scale-110 transition border-2 border-white"></button>
                                <button onclick="setTextColor('#a3e635')" class="w-10 h-10 rounded-full bg-lime-400 flex-shrink-0 shadow-sm hover:scale-110 transition border-2 border-white"></button>
                                <button onclick="setTextColor('#3b82f6')" class="w-10 h-10 rounded-full bg-blue-400 flex-shrink-0 shadow-sm hover:scale-110 transition border-2 border-white"></button>
                                <button onclick="setTextColor('#8b5cf6')" class="w-10 h-10 rounded-full bg-violet-400 flex-shrink-0 shadow-sm hover:scale-110 transition border-2 border-white"></button>
                                <div class="relative w-10 h-10 rounded-full overflow-hidden flex-shrink-0 shadow-sm hover:scale-110 transition border-2 border-white bg-white">
                                    <input type="color" id="custom-color" class="absolute inset-0 w-[150%] h-[150%] -top-[25%] -left-[25%] p-0 border-0 cursor-pointer opacity-0 z-10" onchange="setTextColor(this.value)">
                                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-0">
                                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button onclick="addText()" class="w-full bg-gradient-to-r from-amber-400 to-orange-400 text-white font-extrabold py-4 px-6 rounded-2xl shadow-md hover:shadow-lg btn-hover-pop transition text-lg tracking-wider">
                            è¿½åŠ ã™ã‚‹ âœï¸
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <button onclick="downloadImage()" class="mt-8 w-full bg-gradient-to-r from-pink-400 via-purple-400 to-indigo-400 text-white text-xl font-extrabold py-5 rounded-3xl shadow-xl hover:shadow-2xl btn-hover-pop transition relative overflow-hidden group">
            <span class="relative z-10 flex items-center justify-center gap-2">
                ç”»åƒã‚’ä¿å­˜ã™ã‚‹ (ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰) ğŸ“¥
            </span>
            <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-20 transition duration-300"></div>
        </button>

        <div class="mt-8 text-center pb-10">
            <a href="../index.html" class="inline-flex items-center gap-2 px-6 py-3 bg-white text-amber-500 font-bold rounded-full shadow-md hover:shadow-lg hover:bg-amber-50 transition border-2 border-amber-100">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹
            </a>
        </div>
    </div>

    <script>
        /* =========================================
           å¤‰æ•°ãƒ»åˆæœŸè¨­å®š
           ========================================= */
        const canvas = document.getElementById('photoCanvas');
        const ctx = canvas.getContext('2d');
        const photoInput = document.getElementById('photoInput');
        const customFrameInput = document.getElementById('customFrameInput');
        const customStickerInput = document.getElementById('customStickerInput');
        const placeholder = document.getElementById('placeholder');
        const adjustmentPanel = document.getElementById('adjustment-panel');
        
        let originalImage = null; // åŠ å·¥ç”¨ç”»åƒ
        let frameType = 'none';
        let customFrameImg = null; // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒãƒ‡ãƒ¼ã‚¿
        let frameImages = {}; // ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒã‚’ä¿å­˜ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        
        let objects = [];
        let selectedObject = null;
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        
        const BASE_WIDTH = 800; 
        const BASE_HEIGHT = 450; // 16:9
        canvas.width = BASE_WIDTH;
        canvas.height = BASE_HEIGHT;
        let currentColor = '#f472b6';
        let confettiParticles = [];
        let selectedFukidashiPath = null; // é¸æŠã•ã‚ŒãŸå¹ãå‡ºã—ã®ãƒ‘ã‚¹
        
        // å¹ãå‡ºã—ã®ãƒªã‚¹ãƒˆ
        const fukidashiList = [
            { name: '01', path: 'images/stamp/fukidashi/01.svg' },
            { name: '02', path: 'images/stamp/fukidashi/02.svg' },
            { name: '03', path: 'images/stamp/fukidashi/03.svg' },
            { name: '04', path: 'images/stamp/fukidashi/04.svg' },
            { name: '05', path: 'images/stamp/fukidashi/05.svg' },
            { name: '06', path: 'images/stamp/fukidashi/06.svg' },
            { name: '07', path: 'images/stamp/fukidashi/07.svg' },
            { name: '08', path: 'images/stamp/fukidashi/08.svg' }
        ];
        
        // ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒã®ãƒªã‚¹ãƒˆ
        const frameList = [
            { name: 'Buff the Team', path: 'images/frame/Buff the Team.png' },
            { name: 'Get Things Done', path: 'images/frame/Get Things Done.png' },
            { name: 'More and Better', path: 'images/frame/More and Better.png' },
            { name: 'ç´™å¹é›ª', path: 'images/frame/ç´™å¹é›ª.png' }
        ];
        
        // ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒã‚’èª­ã¿è¾¼ã‚€
        function loadFrameImages() {
            const frameGrid = document.getElementById('frame-grid');
            frameList.forEach((frame, index) => {
                const img = new Image();
                img.onload = () => {
                    frameImages[frame.path] = img;
                };
                img.src = frame.path;
                
                // ãƒ•ãƒ¬ãƒ¼ãƒ é¸æŠãƒœã‚¿ãƒ³ã‚’ä½œæˆ
                const button = document.createElement('button');
                // ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ›´: ä¸¸è§’ã€å½±ä»˜ã
                button.className = 'frame-btn p-2 border-2 border-gray-100 rounded-2xl hover:border-amber-400 hover:shadow-md text-sm font-bold bg-white overflow-hidden relative group transition-all';
                button.onclick = () => setFrame(frame.path);
                
                // ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚’è¡¨ç¤º
                const thumbnail = document.createElement('img');
                thumbnail.src = frame.path;
                thumbnail.className = 'w-full h-20 object-contain mb-2 group-hover:scale-105 transition';
                thumbnail.alt = frame.name;
                
                // ãƒ•ãƒ¬ãƒ¼ãƒ åã‚’è¡¨ç¤º
                const label = document.createElement('div');
                label.className = 'text-xs text-gray-500 font-bold truncate';
                label.textContent = frame.name;
                
                button.appendChild(thumbnail);
                button.appendChild(label);
                frameGrid.appendChild(button);
            });
            
            // ã€Œãªã—ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            const noneButton = document.createElement('button');
            noneButton.className = 'frame-btn p-2 border-2 border-gray-100 rounded-2xl hover:border-amber-400 hover:shadow-md text-sm font-bold bg-white text-gray-400 transition-all';
            noneButton.onclick = () => setFrame('none');
            noneButton.innerHTML = '<span class="text-2xl block mb-1">ğŸš«</span>ãªã—';
            frameGrid.insertBefore(noneButton, frameGrid.firstChild);
        }
        
        // å¹ãå‡ºã—ã®å½¢ã‚’èª­ã¿è¾¼ã‚€
        function loadFukidashiShapes() {
            const shapesGrid = document.getElementById('fukidashi-shapes');
            fukidashiList.forEach((fukidashi) => {
                const button = document.createElement('button');
                button.className = 'p-2 border-2 border-gray-100 rounded-2xl hover:border-amber-400 hover:shadow-md bg-white overflow-hidden relative group transition-all';
                button.onclick = () => selectFukidashiShape(fukidashi.path);
                
                // SVGã‚’èª­ã¿è¾¼ã‚“ã§ã‚µãƒ ãƒã‚¤ãƒ«ã¨ã—ã¦è¡¨ç¤º
                const img = document.createElement('img');
                img.src = fukidashi.path;
                img.className = 'w-full h-16 object-contain group-hover:scale-105 transition';
                img.alt = `å¹ãå‡ºã— ${fukidashi.name}`;
                
                button.appendChild(img);
                shapesGrid.appendChild(button);
            });
        }
        
        // å¹ãå‡ºã—ã®å½¢ã‚’é¸æŠ
        function selectFukidashiShape(path) {
            selectedFukidashiPath = path;
            // è‰²é¸æŠUIã‚’è¡¨ç¤º
            document.getElementById('fukidashi-color-picker').classList.remove('hidden');
        }
        
        // å¹ãå‡ºã—ã®è‰²ã‚’é¸æŠã—ã¦è¿½åŠ 
        function selectFukidashiColor(color) {
            if (!selectedFukidashiPath) return;
            if (!originalImage) { 
                alert('å…ˆã«å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã­ï¼'); 
                return; 
            }
            
            // SVGã‚’èª­ã¿è¾¼ã‚“ã§è‰²ã‚’å¤‰æ›´
            fetch(selectedFukidashiPath)
                .then(response => response.text())
                .then(svgText => {
                    // SVGã®è‰²ã‚’å¤‰æ›´
                    let coloredSvg = svgText;
                    
                    // CSSã‚¯ãƒ©ã‚¹å†…ã®fillã‚’å¤‰æ›´ï¼ˆ.cls-1ã®fillã‚’å¤‰æ›´ï¼‰
                    coloredSvg = coloredSvg.replace(/(\.cls-1\s*\{[^}]*fill:\s*)#[0-9a-fA-F]{3,6}([^}]*\})/gi, `$1${color}$2`);
                    
                    // CSSã‚¯ãƒ©ã‚¹å†…ã®strokeã‚’å¤‰æ›´ï¼ˆ.cls-2ã®strokeã‚’å¤‰æ›´ï¼‰
                    coloredSvg = coloredSvg.replace(/(\.cls-2\s*\{[^}]*stroke:\s*)#[0-9a-fA-F]{3,6}([^}]*\})/gi, `$1${color}$2`);
                    
                    // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã®fillå±æ€§ã‚’å¤‰æ›´
                    coloredSvg = coloredSvg.replace(/fill="[^"]*"/g, `fill="${color}"`);
                    
                    // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã®strokeå±æ€§ã‚’å¤‰æ›´ï¼ˆç™½ã„ç·šã‚’è‰²ã«å¤‰æ›´ï¼‰
                    coloredSvg = coloredSvg.replace(/stroke="[^"]*"/g, `stroke="${color}"`);
                    
                    // SVGã‚’ç”»åƒã«å¤‰æ›
                    const img = new Image();
                    const blob = new Blob([coloredSvg], { type: 'image/svg+xml;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    
                    img.onload = () => {
                        addImageSticker(img);
                        URL.revokeObjectURL(url);
                        // è‰²é¸æŠUIã‚’éè¡¨ç¤ºã«
                        document.getElementById('fukidashi-color-picker').classList.add('hidden');
                        selectedFukidashiPath = null;
                    };
                    img.onerror = () => {
                        console.error('ç”»åƒã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
                        alert('å¹ãå‡ºã—ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        URL.revokeObjectURL(url);
                    };
                    img.src = url;
                })
                .catch(error => {
                    console.error('å¹ãå‡ºã—ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    alert('å¹ãå‡ºã—ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                });
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒã¨å¹ãå‡ºã—ã‚’èª­ã¿è¾¼ã‚€
        loadFrameImages();
        loadFukidashiShapes(); 

        /* =========================================
           ãƒˆãƒªãƒŸãƒ³ã‚°é–¢é€£
           ========================================= */
        const trimmingModal = document.getElementById('trimming-modal');
        const trimCanvas = document.getElementById('trimming-canvas');
        const trimCtx = trimCanvas.getContext('2d');
        const trimScaleSlider = document.getElementById('trim-scale-slider');
        
        let trimSourceImage = null;
        let trimState = { scale: 1, x: 0, y: 0, isDragging: false, lastX: 0, lastY: 0 };
        const TRIM_CANVAS_W = 800; 
        const TRIM_CANVAS_H = 450; // 16:9 

        photoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => { startTrimming(img); };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            e.target.value = ''; 
        });

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿
        customFrameInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    customFrameImg = img;
                    setFrame('custom'); // ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—ã‚’ã‚«ã‚¹ã‚¿ãƒ ã«è¨­å®š
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®èª­ã¿è¾¼ã¿
        customStickerInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    addImageSticker(img);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            e.target.value = ''; // é€£ç¶šã§åŒã˜ç”»åƒã‚’é¸ã¹ã‚‹ã‚ˆã†ã«
        });

        function startTrimming(img) {
            trimSourceImage = img;
            trimmingModal.classList.remove('hidden');
            trimCanvas.width = TRIM_CANVAS_W;
            trimCanvas.height = TRIM_CANVAS_H;
            
            // å®Œå…¨ã«å…¨ä½“ãŒå…¥ã‚‹ã‚ˆã†ã«åˆæœŸè¡¨ç¤º (Fit)
            const scaleW = TRIM_CANVAS_W / img.width;
            const scaleH = TRIM_CANVAS_H / img.height;
            const scale = Math.min(scaleW, scaleH) * 0.8; // å°‘ã—ä½™ç™½ã‚’æŒãŸã›ã‚‹
            
            trimState.scale = scale;
            trimState.x = (TRIM_CANVAS_W - img.width * scale) / 2;
            trimState.y = (TRIM_CANVAS_H - img.height * scale) / 2;
            
            trimScaleSlider.value = 1.0; 
            drawTrimming();
        }

        function drawTrimming() {
            trimCtx.clearRect(0, 0, trimCanvas.width, trimCanvas.height);
            // é€æ˜èƒŒæ™¯ã®ç›®å®‰ã¨ã—ã¦ã‚°ãƒ¬ãƒ¼ã«ã™ã‚‹ -> ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ›´: ãƒ‰ãƒƒãƒˆæŸ„ãªã©
            trimCtx.fillStyle = '#f9fafb'; 
            trimCtx.fillRect(0,0, trimCanvas.width, trimCanvas.height);

            if (!trimSourceImage) return;

            const baseScale = Math.min(TRIM_CANVAS_W / trimSourceImage.width, TRIM_CANVAS_H / trimSourceImage.height) * 0.8;
            
            trimCtx.drawImage(
                trimSourceImage, 
                trimState.x, 
                trimState.y, 
                trimSourceImage.width * trimState.scale, 
                trimSourceImage.height * trimState.scale
            );

            // ã‚¬ã‚¤ãƒ‰æ ï¼ˆ16:9ã®æ ç·šï¼‰
            trimCtx.strokeStyle = '#f59e0b'; // amber-500
            trimCtx.lineWidth = 4;
            trimCtx.setLineDash([10, 5]);
            trimCtx.strokeRect(0, 0, TRIM_CANVAS_W, TRIM_CANVAS_H);
            trimCtx.setLineDash([]);
        }

        trimScaleSlider.addEventListener('input', (e) => {
            const sliderVal = parseFloat(e.target.value);
            const oldScale = trimState.scale;
            
            // åŸºæº–ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆåˆæœŸè¡¨ç¤ºã‚µã‚¤ã‚ºï¼‰
            const baseScale = Math.min(TRIM_CANVAS_W / trimSourceImage.width, TRIM_CANVAS_H / trimSourceImage.height) * 0.8;
            const newScale = baseScale * sliderVal;
            
            const centerX = TRIM_CANVAS_W / 2;
            const centerY = TRIM_CANVAS_H / 2;
            
            trimState.x = centerX - (centerX - trimState.x) * (newScale / oldScale);
            trimState.y = centerY - (centerY - trimState.y) * (newScale / oldScale);
            
            trimState.scale = newScale;
            drawTrimming();
        });

        trimCanvas.addEventListener('mousedown', (e) => {
            trimState.isDragging = true;
            trimState.lastX = e.clientX;
            trimState.lastY = e.clientY;
        });
        trimCanvas.addEventListener('touchstart', (e) => {
            trimState.isDragging = true;
            trimState.lastX = e.touches[0].clientX;
            trimState.lastY = e.touches[0].clientY;
            e.preventDefault();
        });

        const handleTrimMove = (clientX, clientY) => {
            if (!trimState.isDragging) return;
            const dx = clientX - trimState.lastX;
            const dy = clientY - trimState.lastY;
            trimState.x += dx;
            trimState.y += dy;
            trimState.lastX = clientX;
            trimState.lastY = clientY;
            drawTrimming();
        };

        window.addEventListener('mousemove', (e) => handleTrimMove(e.clientX, e.clientY));
        window.addEventListener('touchmove', (e) => handleTrimMove(e.touches[0].clientX, e.touches[0].clientY), {passive: false});

        const stopTrimDrag = () => { trimState.isDragging = false; };
        window.addEventListener('mouseup', stopTrimDrag);
        window.addEventListener('touchend', stopTrimDrag);

        function cancelTrimming() {
            trimmingModal.classList.add('hidden');
            trimSourceImage = null;
        }

        function applyTrimming() {
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = BASE_WIDTH;
            finalCanvas.height = BASE_HEIGHT;
            const fCtx = finalCanvas.getContext('2d');
            
            // ç™½èƒŒæ™¯ã§åˆæœŸåŒ–
            fCtx.fillStyle = '#ffffff';
            fCtx.fillRect(0, 0, BASE_WIDTH, BASE_HEIGHT);

            const drawX = trimState.x;
            const drawY = trimState.y;
            const drawWidth = trimSourceImage.width * trimState.scale;
            const drawHeight = trimSourceImage.height * trimState.scale;
            
            fCtx.drawImage(
                trimSourceImage,
                drawX,
                drawY,
                drawWidth,
                drawHeight
            );
            
            const newImg = new Image();
            newImg.onload = () => {
                originalImage = newImg;
                trimmingModal.classList.add('hidden');
                placeholder.style.display = 'none';
                draw();
                switchTab('frame');
            };
            newImg.src = finalCanvas.toDataURL();
        }


        /* =========================================
           ãƒ¡ã‚¤ãƒ³æç”»ãƒ»ç·¨é›†ãƒ­ã‚¸ãƒƒã‚¯
           ========================================= */
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // ç™½èƒŒæ™¯ã‚’æç”»
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (originalImage) {
                ctx.drawImage(originalImage, 0, 0);
            }

            if (originalImage) {
                drawFrame();
            }

            objects.forEach(obj => {
                ctx.save();
                ctx.translate(obj.x, obj.y);
                ctx.rotate(obj.rotation * Math.PI / 180);
                ctx.scale(obj.scale, obj.scale);

                if (obj.type === 'sticker') {
                    // çµµæ–‡å­—ã‚¹ã‚¿ãƒ³ãƒ—
                    ctx.font = `${obj.fontSize}px serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(obj.content, 0, 0);
                } else if (obj.type === 'image_sticker') {
                    // ç”»åƒã‚¹ã‚¿ãƒ³ãƒ—
                    const w = obj.width;
                    const h = obj.height;
                    // ä¸­å¿ƒã‚’åŸºæº–ã«æç”»
                    ctx.drawImage(obj.img, -w/2, -h/2, w, h);
                } else if (obj.type === 'text') {
                    // ãƒ•ã‚©ãƒ³ãƒˆã‚‚ä¸¸æ–‡å­—ã«å¤‰æ›´
                    ctx.font = `bold ${obj.fontSize}px "M PLUS Rounded 1c", sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.lineJoin = 'round';
                    
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 10; // ç¸å–ã‚Šã‚’å¤ªã
                    ctx.strokeText(obj.content, 0, 0);
                    
                    ctx.fillStyle = obj.color;
                    ctx.fillText(obj.content, 0, 0);
                }

                if (obj === selectedObject) {
                    ctx.strokeStyle = '#f59e0b'; // amber-500
                    ctx.lineWidth = 3 / obj.scale;
                    ctx.setLineDash([8 / obj.scale, 8 / obj.scale]);
                    
                    let boxW = 100;
                    let boxH = 100;

                    if (obj.type === 'sticker') {
                        boxW = obj.fontSize * 1.2;
                        boxH = obj.fontSize * 1.2;
                    } else if (obj.type === 'image_sticker') {
                        boxW = obj.width;
                        boxH = obj.height;
                    } else if (obj.type === 'text') {
                        boxW = ctx.measureText(obj.content).width + 30;
                        boxH = obj.fontSize * 1.2; 
                    }
                    ctx.strokeRect(-boxW/2, -boxH/2, boxW, boxH);
                    
                    // é¸æŠæ ã®è§’ã«ä¸¸ã„ãƒãƒ³ãƒ‰ãƒ«ã‚’æç”»ï¼ˆè£…é£¾ï¼‰
                    ctx.fillStyle = '#f59e0b';
                    const handleSize = 10 / obj.scale;
                    ctx.beginPath(); ctx.arc(-boxW/2, -boxH/2, handleSize, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(boxW/2, -boxH/2, handleSize, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(boxW/2, boxH/2, handleSize, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(-boxW/2, boxH/2, handleSize, 0, Math.PI*2); ctx.fill();
                }
                ctx.restore();
            });
        }

        /* ç´™å¹é›ªç”Ÿæˆ */
        function generateConfetti() {
            confettiParticles = [];
            const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#FF9F43', '#54A0FF', '#FD79A8'];
            for(let i=0; i<80; i++) {
                confettiParticles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 8 + 4,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    rotation: Math.random() * 360,
                    type: Math.random() > 0.5 ? 'circle' : 'rect'
                });
            }
        }

        function drawFrame() {
            const w = canvas.width;
            const h = canvas.height;
            ctx.save();
            
            if (frameType === 'none') {
                // ãƒ•ãƒ¬ãƒ¼ãƒ ãªã—
            } else if (frameType === 'custom' && customFrameImg) {
                // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æç”»ï¼ˆå…¨ä½“ã«å¼•ãä¼¸ã°ã™ï¼‰
                ctx.drawImage(customFrameImg, 0, 0, w, h);
            } else if (frameImages[frameType]) {
                // ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒã‚’æç”»ï¼ˆå…¨ä½“ã«å¼•ãä¼¸ã°ã™ï¼‰
                ctx.drawImage(frameImages[frameType], 0, 0, w, h);
            }
            ctx.restore();
        }

        /* =========================================
           UIãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
           ========================================= */
        function addSticker(content) {
            if (!originalImage) { alert('å…ˆã«å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã­ï¼'); return; }
            const obj = {
                type: 'sticker',
                content: content,
                x: canvas.width / 2 + (Math.random() * 40 - 20),
                y: canvas.height / 2 + (Math.random() * 40 - 20),
                scale: 1.0,
                rotation: 0,
                fontSize: 120
            };
            objects.push(obj);
            setSelectedObject(obj);
            draw();
        }

        // ç”»åƒã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ 
        function addImageSticker(img) {
            if (!originalImage) { alert('å…ˆã«å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã­ï¼'); return; }
            
            // ã‚µã‚¤ã‚ºèª¿æ•´ï¼ˆå¤§ãã™ãã‚‹ã¨æ‰±ã„ã¥ã‚‰ã„ãŸã‚ã€é©åº¦ãªã‚µã‚¤ã‚ºã«ç¸®å°ï¼‰
            const maxSize = 200;
            let w = img.width;
            let h = img.height;
            if (w > h && w > maxSize) {
                h = (maxSize / w) * h;
                w = maxSize;
            } else if (h > maxSize) {
                w = (maxSize / h) * w;
                h = maxSize;
            }

            const obj = {
                type: 'image_sticker',
                img: img,
                width: w,
                height: h,
                x: canvas.width / 2,
                y: canvas.height / 2,
                scale: 1.0,
                rotation: 0
            };
            objects.push(obj);
            setSelectedObject(obj);
            draw();
        }

        function addText() {
            if (!originalImage) { alert('å…ˆã«å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã­ï¼'); return; }
            const input = document.getElementById('text-input');
            const text = input.value.trim();
            if (!text) return;
            const obj = {
                type: 'text',
                content: text,
                x: canvas.width / 2,
                y: canvas.height / 2,
                scale: 1.0,
                rotation: 0,
                fontSize: 80,
                color: currentColor
            };
            objects.push(obj);
            setSelectedObject(obj);
            draw();
            input.value = '';
        }

        function setTextColor(color) {
            currentColor = color;
            if (selectedObject && selectedObject.type === 'text') {
                selectedObject.color = color;
                draw();
            }
        }

        function setFrame(type) {
            frameType = type;
            draw();
        }

        function setSelectedObject(obj) {
            selectedObject = obj;
            if (obj) {
                adjustmentPanel.classList.remove('hidden');
                document.getElementById('scale-slider').value = obj.scale;
                document.getElementById('rotation-slider').value = obj.rotation;
            } else {
                adjustmentPanel.classList.add('hidden');
            }
            draw();
        }

        function deleteSelectedObject() {
            if (selectedObject) {
                objects = objects.filter(o => o !== selectedObject);
                setSelectedObject(null);
                draw();
            }
        }

        function updateObjectProperty(prop, value) {
            if (!selectedObject) return;
            selectedObject[prop] = parseFloat(value);
            draw();
        }

        function getCanvasPoint(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function hitTest(x, y) {
            for (let i = objects.length - 1; i >= 0; i--) {
                const obj = objects[i];
                let hitRadius = 50; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

                if (obj.type === 'sticker') {
                    hitRadius = (obj.fontSize * obj.scale) / 1.5;
                } else if (obj.type === 'image_sticker') {
                    hitRadius = (Math.max(obj.width, obj.height) * obj.scale) / 2;
                } else if (obj.type === 'text') {
                     hitRadius = (obj.fontSize * obj.scale) * 1.5; // ãƒ†ã‚­ã‚¹ãƒˆã¯å°‘ã—åºƒã‚ã«
                }

                const dx = x - obj.x;
                const dy = y - obj.y;
                if (dx*dx + dy*dy < hitRadius*hitRadius) { 
                    return obj;
                }
            }
            return null;
        }

        // ãƒ¡ã‚¤ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ç”¨ã‚¤ãƒ™ãƒ³ãƒˆ
        canvas.addEventListener('mousedown', startDrag);
        canvas.addEventListener('touchstart', startDrag, { passive: false });
        canvas.addEventListener('mousemove', drag);
        canvas.addEventListener('touchmove', drag, { passive: false });
        canvas.addEventListener('mouseup', endDrag);
        canvas.addEventListener('touchend', endDrag);
        canvas.addEventListener('mouseleave', endDrag);

        function startDrag(e) {
            if (!originalImage && objects.length === 0) return;
            e.preventDefault();
            const p = getCanvasPoint(e);
            const hit = hitTest(p.x, p.y);
            if (hit) {
                if (hit !== selectedObject) {
                    objects = objects.filter(o => o !== hit);
                    objects.push(hit);
                    setSelectedObject(hit);
                }
                isDragging = true;
                dragStart = { x: p.x - hit.x, y: p.y - hit.y };
            } else {
                setSelectedObject(null);
            }
            draw();
        }

        function drag(e) {
            if (!isDragging || !selectedObject) return;
            e.preventDefault();
            const p = getCanvasPoint(e);
            selectedObject.x = p.x - dragStart.x;
            selectedObject.y = p.y - dragStart.y;
            draw();
        }

        function endDrag() { isDragging = false; }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                // ã‚¹ã‚¿ã‚¤ãƒ«ãƒªã‚»ãƒƒãƒˆ
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });
        }

        function downloadImage() {
            if (!originalImage) {
                alert("ã¾ãšã¯å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼");
                return;
            }
            const currentSelection = selectedObject;
            selectedObject = null;
            draw();
            const link = document.createElement('a');
            link.download = 'stakane-deco-v5.png'; // ãƒ•ã‚¡ã‚¤ãƒ«åã‚‚å¤‰æ›´
            link.href = canvas.toDataURL('image/png');
            link.click();
            selectedObject = currentSelection;
            draw();
        }
        
        draw();
    </script>
</body>
</html>