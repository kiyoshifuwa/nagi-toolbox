<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ—ãƒªã‚¯ãƒ©é¢¨ãƒ•ã‚©ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ V5 (ã‚«ã‚¹ã‚¿ãƒ ç”»åƒå¯¾å¿œ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans JP', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ - 16:9 */
        #canvas-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            aspect-ratio: 16 / 9;
            position: relative;
            overflow: hidden;
            border: 2px solid #818cf8;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            background-color: #f3f4f6;
            /* é€æ˜èƒŒæ™¯ã‚’è¡¨ã™å¸‚æ¾æ¨¡æ§˜ */
            background-image: 
                linear-gradient(45deg, #e5e7eb 25%, transparent 25%, transparent 75%, #e5e7eb 75%, #e5e7eb),
                linear-gradient(45deg, #e5e7eb 25%, transparent 25%, transparent 75%, #e5e7eb 75%, #e5e7eb);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }
        #photoCanvas {
            display: block;
            width: 100%;
            height: 100%;
            touch-action: none;
            user-select: none;
            cursor: grab;
        }
        #photoCanvas:active {
            cursor: grabbing;
        }
        /* ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #trimming-canvas {
            border: 2px dashed #6366f1;
            background-color: #f3f4f6;
            cursor: move;
        }

        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #6366f1;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #c7c7cc;
            border-radius: 2px;
        }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .custom-file-upload {
            display: inline-block;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen py-6 font-sans text-gray-800">

    <!-- ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="trimming-modal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-90 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 animate-fade-in flex flex-col max-h-[90vh]">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <svg class="w-6 h-6 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’èª¿æ•´ (16:9)
            </h2>
            
            <div class="flex-1 min-h-0 flex items-center justify-center bg-gray-100 rounded-lg overflow-hidden relative mb-4">
                <canvas id="trimming-canvas"></canvas>
            </div>

            <div class="space-y-4">
                <div class="flex items-center gap-4">
                    <span class="text-sm font-bold text-gray-500 w-12">å€ç‡</span>
                    <span class="text-lg">ğŸ”</span>
                    <input type="range" id="trim-scale-slider" min="0.1" max="3.0" step="0.01" value="1.0">
                </div>
                
                <div class="flex gap-3">
                    <button onclick="cancelTrimming()" class="flex-1 py-3 px-4 rounded-lg border border-gray-300 font-bold text-gray-600 hover:bg-gray-50 transition">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button onclick="applyTrimming()" class="flex-1 py-3 px-4 rounded-lg bg-indigo-600 font-bold text-white hover:bg-indigo-700 shadow-md transition">
                        æ±ºå®šã™ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-indigo-600 tracking-tight">âœ¨ ãƒ—ãƒªã‚¯ãƒ©ãƒ¡ãƒ¼ã‚«ãƒ¼ V5 âœ¨</h1>
            <p class="text-sm text-gray-500 mt-2">è‡ªä½œã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚„ã‚¹ã‚¿ãƒ³ãƒ—ç”»åƒã‚‚ä½¿ãˆã¾ã™ï¼</p>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ -->
        <div id="canvas-container" class="mb-6 bg-white shadow-xl">
            <!-- 800x450 (16:9) -->
            <canvas id="photoCanvas" width="800" height="450"></canvas>
            
            <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 p-6 pointer-events-none">
                <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 16m-2-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
                <p class="text-lg font-bold text-gray-500">å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
            </div>
        </div>

        <!-- ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆèª¿æ•´ãƒ‘ãƒãƒ« -->
        <div id="adjustment-panel" class="hidden bg-white p-4 rounded-xl shadow-lg border-2 border-indigo-100 mb-6 animate-fade-in">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-indigo-600 font-bold flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    èª¿æ•´
                </h3>
                <button onclick="deleteSelectedObject()" class="text-red-500 hover:text-red-700 font-bold text-sm px-3 py-1 bg-red-50 rounded-lg border border-red-100 hover:bg-red-100 transition">å‰Šé™¤ ğŸ—‘ï¸</button>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div class="flex items-center gap-4">
                    <span class="text-sm font-medium text-gray-600 w-12">å¤§ãã•</span>
                    <input type="range" id="scale-slider" min="0.2" max="3.0" step="0.05" value="1.0" oninput="updateObjectProperty('scale', this.value)">
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm font-medium text-gray-600 w-12">è§’åº¦</span>
                    <input type="range" id="rotation-slider" min="-180" max="180" step="1" value="0" oninput="updateObjectProperty('rotation', this.value)">
                </div>
            </div>
        </div>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="flex overflow-x-auto bg-gray-50 border-b border-gray-100">
                <button onclick="switchTab('upload')" class="tab-btn active px-6 py-4 font-bold text-sm text-gray-500 hover:bg-gray-100 focus:outline-none whitespace-nowrap" data-tab="upload">ğŸ“ å†™çœŸ</button>
                <button onclick="switchTab('frame')" class="tab-btn px-6 py-4 font-bold text-sm text-gray-500 hover:bg-gray-100 focus:outline-none whitespace-nowrap" data-tab="frame">ğŸ–¼ï¸ ãƒ•ãƒ¬ãƒ¼ãƒ </button>
                <button onclick="switchTab('sticker')" class="tab-btn px-6 py-4 font-bold text-sm text-gray-500 hover:bg-gray-100 focus:outline-none whitespace-nowrap" data-tab="sticker">âœ¨ ã‚¹ã‚¿ãƒ³ãƒ—</button>
                <button onclick="switchTab('text')" class="tab-btn px-6 py-4 font-bold text-sm text-gray-500 hover:bg-gray-100 focus:outline-none whitespace-nowrap" data-tab="text">âœï¸ æ–‡å­—</button>
            </div>

            <div class="p-6">
                <!-- å†™çœŸã‚¿ãƒ– -->
                <div id="tab-upload" class="tab-content block">
                    <div class="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg p-8 bg-gray-50 hover:bg-gray-100 transition relative">
                        <input type="file" id="photoInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <svg class="w-12 h-12 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <span class="text-indigo-500 font-bold">ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’é¸æŠ</span>
                    </div>
                </div>

                <!-- ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¿ãƒ– -->
                <div id="tab-frame" class="tab-content hidden">
                    <div class="mb-4 p-4 bg-indigo-50 rounded-lg border border-indigo-100">
                        <label class="block text-indigo-700 font-bold mb-2 text-sm">ğŸ“ ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ•ãƒ¬ãƒ¼ãƒ  (PNGæ¨å¥¨)</label>
                        <input type="file" id="customFrameInput" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200"/>
                        <p class="text-xs text-gray-500 mt-1">â€»ä¸­å¤®ãŒé€æ˜ãªPNGç”»åƒã‚’é¸ã¶ã¨ç¶ºéº—ã«åˆæˆã§ãã¾ã™ã€‚</p>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3" id="frame-grid">
                        <!-- ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
                    </div>
                </div>

                <!-- ã‚¹ã‚¿ãƒ³ãƒ—ã‚¿ãƒ– -->
                <div id="tab-sticker" class="tab-content hidden">
                    <div class="mb-4 p-4 bg-indigo-50 rounded-lg border border-indigo-100">
                        <label class="block text-indigo-700 font-bold mb-2 text-sm">ğŸ“ ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ </label>
                        <input type="file" id="customStickerInput" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200"/>
                    </div>

                    <div class="flex flex-wrap gap-3">
                        <button onclick="addSticker('ğŸ’–')" class="text-4xl p-2 hover:bg-gray-100 rounded-lg transition transform hover:scale-125">ğŸ’–</button>
                        <button onclick="addSticker('âœ¨')" class="text-4xl p-2 hover:bg-gray-100 rounded-lg transition transform hover:scale-125">âœ¨</button>
                        <button onclick="addSticker('â­')" class="text-4xl p-2 hover:bg-gray-100 rounded-lg transition transform hover:scale-125">â­</button>
                        <button onclick="addSticker('ğŸ‰')" class="text-4xl p-2 hover:bg-gray-100 rounded-lg transition transform hover:scale-125">ğŸ‰</button>
                        <button onclick="addSticker('ğŸŒ¸')" class="text-4xl p-2 hover:bg-gray-100 rounded-lg transition transform hover:scale-125">ğŸŒ¸</button>
                        <button onclick="addSticker('ğŸ€')" class="text-4xl p-2 hover:bg-gray-100 rounded-lg transition transform hover:scale-125">ğŸ€</button>
                        <button onclick="addSticker('ğŸ‘‘')" class="text-4xl p-2 hover:bg-gray-100 rounded-lg transition transform hover:scale-125">ğŸ‘‘</button>
                        <button onclick="addSticker('ğŸ¦‹')" class="text-4xl p-2 hover:bg-gray-100 rounded-lg transition transform hover:scale-125">ğŸ¦‹</button>
                        <button onclick="addSticker('ğŸ±')" class="text-4xl p-2 hover:bg-gray-100 rounded-lg transition transform hover:scale-125">ğŸ±</button>
                        <button onclick="addSticker('ğŸ¶')" class="text-4xl p-2 hover:bg-gray-100 rounded-lg transition transform hover:scale-125">ğŸ¶</button>
                        <button onclick="addSticker('ğŸ˜')" class="text-4xl p-2 hover:bg-gray-100 rounded-lg transition transform hover:scale-125">ğŸ˜</button>
                        <button onclick="addSticker('ğŸ‚')" class="text-4xl p-2 hover:bg-gray-100 rounded-lg transition transform hover:scale-125">ğŸ‚</button>
                    </div>
                </div>

                <!-- æ–‡å­—ã‚¿ãƒ– -->
                <div id="tab-text" class="tab-content hidden">
                    <div class="space-y-4">
                        <input type="text" id="text-input" placeholder="æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ã­" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500 transition">
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <label class="text-xs text-gray-500 font-bold block mb-1">ã‚«ãƒ©ãƒ¼</label>
                                <div class="flex gap-2 overflow-x-auto pb-2">
                                    <button onclick="setTextColor('#000000')" class="w-8 h-8 rounded-full bg-black border border-gray-200 flex-shrink-0"></button>
                                    <button onclick="setTextColor('#ffffff')" class="w-8 h-8 rounded-full bg-white border border-gray-200 flex-shrink-0"></button>
                                    <button onclick="setTextColor('#ef4444')" class="w-8 h-8 rounded-full bg-red-500 flex-shrink-0"></button>
                                    <button onclick="setTextColor('#f472b6')" class="w-8 h-8 rounded-full bg-pink-400 flex-shrink-0"></button>
                                    <button onclick="setTextColor('#fbbf24')" class="w-8 h-8 rounded-full bg-amber-400 flex-shrink-0"></button>
                                    <button onclick="setTextColor('#3b82f6')" class="w-8 h-8 rounded-full bg-blue-500 flex-shrink-0"></button>
                                    <button onclick="setTextColor('#8b5cf6')" class="w-8 h-8 rounded-full bg-violet-500 flex-shrink-0"></button>
                                    <input type="color" id="custom-color" class="w-8 h-8 p-0 border-0 rounded-full overflow-hidden" onchange="setTextColor(this.value)">
                                </div>
                            </div>
                        </div>
                        <button onclick="addText()" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 active:transform active:scale-95 transition">è¿½åŠ ã™ã‚‹</button>
                    </div>
                </div>
            </div>
        </div>

        <button onclick="downloadImage()" class="mt-6 w-full bg-gradient-to-r from-pink-500 to-indigo-500 text-white text-lg font-bold py-4 rounded-xl shadow-xl hover:shadow-2xl hover:opacity-90 transform transition hover:-translate-y-1">
            ç”»åƒã¨ã—ã¦ä¿å­˜ (ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰) ğŸ“¥
        </button>
    </div>

    <script>
        /* =========================================
           å¤‰æ•°ãƒ»åˆæœŸè¨­å®š
           ========================================= */
        const canvas = document.getElementById('photoCanvas');
        const ctx = canvas.getContext('2d');
        const photoInput = document.getElementById('photoInput');
        const customFrameInput = document.getElementById('customFrameInput');
        const customStickerInput = document.getElementById('customStickerInput');
        const placeholder = document.getElementById('placeholder');
        const adjustmentPanel = document.getElementById('adjustment-panel');
        
        let originalImage = null; // åŠ å·¥ç”¨ç”»åƒ
        let frameType = 'none';
        let customFrameImg = null; // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒãƒ‡ãƒ¼ã‚¿
        let frameImages = {}; // ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒã‚’ä¿å­˜ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        
        let objects = [];
        let selectedObject = null;
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        
        const BASE_WIDTH = 800; 
        const BASE_HEIGHT = 450; // 16:9
        canvas.width = BASE_WIDTH;
        canvas.height = BASE_HEIGHT;
        let currentColor = '#f472b6';
        let confettiParticles = [];
        
        // ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒã®ãƒªã‚¹ãƒˆ
        const frameList = [
            { name: 'Buff the Team', path: 'images/frame/Buff the Team.png' },
            { name: 'Get Things Done', path: 'images/frame/Get Things Done.png' },
            { name: 'More and Better', path: 'images/frame/More and Better.png' },
            { name: 'ç´™å¹é›ª', path: 'images/frame/ç´™å¹é›ª.png' }
        ];
        
        // ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒã‚’èª­ã¿è¾¼ã‚€
        function loadFrameImages() {
            const frameGrid = document.getElementById('frame-grid');
            frameList.forEach((frame, index) => {
                const img = new Image();
                img.onload = () => {
                    frameImages[frame.path] = img;
                };
                img.src = frame.path;
                
                // ãƒ•ãƒ¬ãƒ¼ãƒ é¸æŠãƒœã‚¿ãƒ³ã‚’ä½œæˆ
                const button = document.createElement('button');
                button.className = 'frame-btn p-3 border-2 border-gray-200 rounded-lg hover:border-indigo-500 text-sm font-bold bg-white overflow-hidden relative group';
                button.onclick = () => setFrame(frame.path);
                
                // ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚’è¡¨ç¤º
                const thumbnail = document.createElement('img');
                thumbnail.src = frame.path;
                thumbnail.className = 'w-full h-20 object-contain mb-2';
                thumbnail.alt = frame.name;
                
                // ãƒ•ãƒ¬ãƒ¼ãƒ åã‚’è¡¨ç¤º
                const label = document.createElement('div');
                label.className = 'text-xs text-gray-600 font-bold truncate';
                label.textContent = frame.name;
                
                button.appendChild(thumbnail);
                button.appendChild(label);
                frameGrid.appendChild(button);
            });
            
            // ã€Œãªã—ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            const noneButton = document.createElement('button');
            noneButton.className = 'frame-btn p-3 border-2 border-gray-200 rounded-lg hover:border-indigo-500 text-sm font-bold bg-white';
            noneButton.onclick = () => setFrame('none');
            noneButton.innerHTML = 'ğŸš« ãªã—';
            frameGrid.insertBefore(noneButton, frameGrid.firstChild);
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒã‚’èª­ã¿è¾¼ã‚€
        loadFrameImages(); 

        /* =========================================
           ãƒˆãƒªãƒŸãƒ³ã‚°é–¢é€£
           ========================================= */
        const trimmingModal = document.getElementById('trimming-modal');
        const trimCanvas = document.getElementById('trimming-canvas');
        const trimCtx = trimCanvas.getContext('2d');
        const trimScaleSlider = document.getElementById('trim-scale-slider');
        
        let trimSourceImage = null;
        let trimState = { scale: 1, x: 0, y: 0, isDragging: false, lastX: 0, lastY: 0 };
        const TRIM_CANVAS_W = 800; 
        const TRIM_CANVAS_H = 450; // 16:9 

        photoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => { startTrimming(img); };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            e.target.value = ''; 
        });

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿
        customFrameInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    customFrameImg = img;
                    setFrame('custom'); // ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—ã‚’ã‚«ã‚¹ã‚¿ãƒ ã«è¨­å®š
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®èª­ã¿è¾¼ã¿
        customStickerInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    addImageSticker(img);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            e.target.value = ''; // é€£ç¶šã§åŒã˜ç”»åƒã‚’é¸ã¹ã‚‹ã‚ˆã†ã«
        });

        function startTrimming(img) {
            trimSourceImage = img;
            trimmingModal.classList.remove('hidden');
            trimCanvas.width = TRIM_CANVAS_W;
            trimCanvas.height = TRIM_CANVAS_H;
            
            // å®Œå…¨ã«å…¨ä½“ãŒå…¥ã‚‹ã‚ˆã†ã«åˆæœŸè¡¨ç¤º (Fit)
            const scaleW = TRIM_CANVAS_W / img.width;
            const scaleH = TRIM_CANVAS_H / img.height;
            const scale = Math.min(scaleW, scaleH) * 0.8; // å°‘ã—ä½™ç™½ã‚’æŒãŸã›ã‚‹
            
            trimState.scale = scale;
            trimState.x = (TRIM_CANVAS_W - img.width * scale) / 2;
            trimState.y = (TRIM_CANVAS_H - img.height * scale) / 2;
            
            trimScaleSlider.value = 1.0; 
            drawTrimming();
        }

        function drawTrimming() {
            trimCtx.clearRect(0, 0, trimCanvas.width, trimCanvas.height);
            // é€æ˜èƒŒæ™¯ã®ç›®å®‰ã¨ã—ã¦ã‚°ãƒ¬ãƒ¼ã«ã™ã‚‹
            trimCtx.fillStyle = '#e5e7eb'; 
            trimCtx.fillRect(0,0, trimCanvas.width, trimCanvas.height);

            if (!trimSourceImage) return;

            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤(0.1~3.0) Ã— åˆæœŸã‚¹ã‚±ãƒ¼ãƒ«
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ‹¡å¤§ç¸®å°ã‚’è‡ªç”±ã«è¡Œã†
            const baseScale = Math.min(TRIM_CANVAS_W / trimSourceImage.width, TRIM_CANVAS_H / trimSourceImage.height) * 0.8;
            
            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€¤ã‚’å¯¾æ•°çš„ã«æ‰±ã£ãŸã‚Šèª¿æ•´ã‚‚ã§ãã‚‹ãŒã€ã‚·ãƒ³ãƒ—ãƒ«ã«
            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼1.0 = åˆæœŸè¡¨ç¤ºã‚µã‚¤ã‚º ã¨ã™ã‚‹
            
            // å‰å›æç”»æ™‚ã®å€ç‡ã‚’ä¿æŒã—ã¦ã„ãªã„ã¨ã‚ºãƒ¼ãƒ ä¸­å¿ƒãŒãšã‚Œã‚‹ãŸã‚ã€
            // ç°¡æ˜“çš„ã«ä¸­å¿ƒã‚ºãƒ¼ãƒ ã‚’å®Ÿè£…ã™ã‚‹
            // ï¼ˆã“ã®ã‚³ãƒ¼ãƒ‰ã¯ç°¡æ˜“ç‰ˆã§ã™ï¼‰

            trimCtx.drawImage(
                trimSourceImage, 
                trimState.x, 
                trimState.y, 
                trimSourceImage.width * trimState.scale, 
                trimSourceImage.height * trimState.scale
            );

            // ã‚¬ã‚¤ãƒ‰æ ï¼ˆ16:9ã®æ ç·šï¼‰
            // ã“ã“ã§ã¯ã‚­ãƒ£ãƒ³ãƒã‚¹å…¨ä½“ãŒ16:9ãªã®ã§æ ç·šã‚’è¡¨ç¤º
            trimCtx.strokeStyle = '#6366f1';
            trimCtx.lineWidth = 2;
            trimCtx.strokeRect(0, 0, TRIM_CANVAS_W, TRIM_CANVAS_H);
            
            // å¤–å´ã‚’å°‘ã—æš—ãã—ã¦ãƒˆãƒªãƒŸãƒ³ã‚°ç¯„å›²ã‚’ã‚ã‹ã‚Šã‚„ã™ã
            // (ä»Šå›ã¯ã‚­ãƒ£ãƒ³ãƒã‚¹å…¨ä½“ï¼ãƒˆãƒªãƒŸãƒ³ã‚°ç¯„å›²ãªã®ã§ä¸è¦ã ãŒã€æ¼”å‡ºã¨ã—ã¦)
        }

        trimScaleSlider.addEventListener('input', (e) => {
            const sliderVal = parseFloat(e.target.value);
            const oldScale = trimState.scale;
            
            // åŸºæº–ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆåˆæœŸè¡¨ç¤ºã‚µã‚¤ã‚ºï¼‰
            const baseScale = Math.min(TRIM_CANVAS_W / trimSourceImage.width, TRIM_CANVAS_H / trimSourceImage.height) * 0.8;
            const newScale = baseScale * sliderVal;
            
            const centerX = TRIM_CANVAS_W / 2;
            const centerY = TRIM_CANVAS_H / 2;
            
            trimState.x = centerX - (centerX - trimState.x) * (newScale / oldScale);
            trimState.y = centerY - (centerY - trimState.y) * (newScale / oldScale);
            
            trimState.scale = newScale;
            drawTrimming();
        });

        trimCanvas.addEventListener('mousedown', (e) => {
            trimState.isDragging = true;
            trimState.lastX = e.clientX;
            trimState.lastY = e.clientY;
        });
        trimCanvas.addEventListener('touchstart', (e) => {
            trimState.isDragging = true;
            trimState.lastX = e.touches[0].clientX;
            trimState.lastY = e.touches[0].clientY;
            e.preventDefault();
        });

        const handleTrimMove = (clientX, clientY) => {
            if (!trimState.isDragging) return;
            const dx = clientX - trimState.lastX;
            const dy = clientY - trimState.lastY;
            trimState.x += dx;
            trimState.y += dy;
            trimState.lastX = clientX;
            trimState.lastY = clientY;
            drawTrimming();
        };

        window.addEventListener('mousemove', (e) => handleTrimMove(e.clientX, e.clientY));
        window.addEventListener('touchmove', (e) => handleTrimMove(e.touches[0].clientX, e.touches[0].clientY), {passive: false});

        const stopTrimDrag = () => { trimState.isDragging = false; };
        window.addEventListener('mouseup', stopTrimDrag);
        window.addEventListener('touchend', stopTrimDrag);

        function cancelTrimming() {
            trimmingModal.classList.add('hidden');
            trimSourceImage = null;
        }

        function applyTrimming() {
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = BASE_WIDTH;
            finalCanvas.height = BASE_HEIGHT;
            const fCtx = finalCanvas.getContext('2d');
            
            // ç™½èƒŒæ™¯ã§åˆæœŸåŒ–ï¼ˆé€æ˜éƒ¨åˆ†ãŒå‡ºãªã„ã‚ˆã†ã«ï¼‰
            fCtx.fillStyle = '#ffffff';
            fCtx.fillRect(0, 0, BASE_WIDTH, BASE_HEIGHT);

            const ratio = BASE_WIDTH / TRIM_CANVAS_W;
            
            fCtx.drawImage(
                trimSourceImage,
                trimState.x * ratio,
                trimState.y * ratio,
                trimSourceImage.width * trimState.scale * ratio,
                trimSourceImage.height * trimState.scale * ratio
            );
            
            const newImg = new Image();
            newImg.onload = () => {
                originalImage = newImg;
                trimmingModal.classList.add('hidden');
                placeholder.style.display = 'none';
                draw();
                switchTab('frame');
            };
            newImg.src = finalCanvas.toDataURL();
        }


        /* =========================================
           ãƒ¡ã‚¤ãƒ³æç”»ãƒ»ç·¨é›†ãƒ­ã‚¸ãƒƒã‚¯
           ========================================= */
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // ç™½èƒŒæ™¯ã‚’æç”»
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (originalImage) {
                ctx.drawImage(originalImage, 0, 0);
            }

            if (originalImage) {
                drawFrame();
            }

            objects.forEach(obj => {
                ctx.save();
                ctx.translate(obj.x, obj.y);
                ctx.rotate(obj.rotation * Math.PI / 180);
                ctx.scale(obj.scale, obj.scale);

                if (obj.type === 'sticker') {
                    // çµµæ–‡å­—ã‚¹ã‚¿ãƒ³ãƒ—
                    ctx.font = `${obj.fontSize}px serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(obj.content, 0, 0);
                } else if (obj.type === 'image_sticker') {
                    // ç”»åƒã‚¹ã‚¿ãƒ³ãƒ—
                    const w = obj.width;
                    const h = obj.height;
                    // ä¸­å¿ƒã‚’åŸºæº–ã«æç”»
                    ctx.drawImage(obj.img, -w/2, -h/2, w, h);
                } else if (obj.type === 'text') {
                    ctx.font = `bold ${obj.fontSize}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.lineJoin = 'round';
                    
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 4;
                    ctx.strokeText(obj.content, 0, 0);
                    
                    ctx.fillStyle = obj.color;
                    ctx.fillText(obj.content, 0, 0);
                }

                if (obj === selectedObject) {
                    ctx.strokeStyle = '#6366f1';
                    ctx.lineWidth = 2 / obj.scale;
                    ctx.setLineDash([5 / obj.scale, 5 / obj.scale]);
                    
                    let boxW = 100;
                    let boxH = 100;

                    if (obj.type === 'sticker') {
                        boxW = obj.fontSize * 1.2;
                        boxH = obj.fontSize * 1.2;
                    } else if (obj.type === 'image_sticker') {
                        boxW = obj.width;
                        boxH = obj.height;
                    } else if (obj.type === 'text') {
                        boxW = ctx.measureText(obj.content).width + 20;
                        boxH = obj.fontSize * 1.2; 
                    }
                    ctx.strokeRect(-boxW/2, -boxH/2, boxW, boxH);
                }
                ctx.restore();
            });
        }

        /* ç´™å¹é›ªç”Ÿæˆ */
        function generateConfetti() {
            confettiParticles = [];
            const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#FF9F43', '#54A0FF', '#FD79A8'];
            for(let i=0; i<80; i++) {
                confettiParticles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 8 + 4,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    rotation: Math.random() * 360,
                    type: Math.random() > 0.5 ? 'circle' : 'rect'
                });
            }
        }

        function drawFrame() {
            const w = canvas.width;
            const h = canvas.height;
            ctx.save();
            
            if (frameType === 'none') {
                // ãƒ•ãƒ¬ãƒ¼ãƒ ãªã—
            } else if (frameType === 'custom' && customFrameImg) {
                // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æç”»ï¼ˆå…¨ä½“ã«å¼•ãä¼¸ã°ã™ï¼‰
                ctx.drawImage(customFrameImg, 0, 0, w, h);
            } else if (frameImages[frameType]) {
                // ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒã‚’æç”»ï¼ˆå…¨ä½“ã«å¼•ãä¼¸ã°ã™ï¼‰
                ctx.drawImage(frameImages[frameType], 0, 0, w, h);
            }
            ctx.restore();
        }

        /* =========================================
           UIãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
           ========================================= */
        function addSticker(content) {
            if (!originalImage) { alert('å…ˆã«å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã­ï¼'); return; }
            const obj = {
                type: 'sticker',
                content: content,
                x: canvas.width / 2 + (Math.random() * 40 - 20),
                y: canvas.height / 2 + (Math.random() * 40 - 20),
                scale: 1.0,
                rotation: 0,
                fontSize: 120
            };
            objects.push(obj);
            setSelectedObject(obj);
            draw();
        }

        // ç”»åƒã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ 
        function addImageSticker(img) {
            if (!originalImage) { alert('å…ˆã«å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã­ï¼'); return; }
            
            // ã‚µã‚¤ã‚ºèª¿æ•´ï¼ˆå¤§ãã™ãã‚‹ã¨æ‰±ã„ã¥ã‚‰ã„ãŸã‚ã€é©åº¦ãªã‚µã‚¤ã‚ºã«ç¸®å°ï¼‰
            const maxSize = 200;
            let w = img.width;
            let h = img.height;
            if (w > h && w > maxSize) {
                h = (maxSize / w) * h;
                w = maxSize;
            } else if (h > maxSize) {
                w = (maxSize / h) * w;
                h = maxSize;
            }

            const obj = {
                type: 'image_sticker',
                img: img,
                width: w,
                height: h,
                x: canvas.width / 2,
                y: canvas.height / 2,
                scale: 1.0,
                rotation: 0
            };
            objects.push(obj);
            setSelectedObject(obj);
            draw();
        }

        function addText() {
            if (!originalImage) { alert('å…ˆã«å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã­ï¼'); return; }
            const input = document.getElementById('text-input');
            const text = input.value.trim();
            if (!text) return;
            const obj = {
                type: 'text',
                content: text,
                x: canvas.width / 2,
                y: canvas.height / 2,
                scale: 1.0,
                rotation: 0,
                fontSize: 80,
                color: currentColor
            };
            objects.push(obj);
            setSelectedObject(obj);
            draw();
            input.value = '';
        }

        function setTextColor(color) {
            currentColor = color;
            if (selectedObject && selectedObject.type === 'text') {
                selectedObject.color = color;
                draw();
            }
        }

        function setFrame(type) {
            frameType = type;
            draw();
        }

        function setSelectedObject(obj) {
            selectedObject = obj;
            if (obj) {
                adjustmentPanel.classList.remove('hidden');
                document.getElementById('scale-slider').value = obj.scale;
                document.getElementById('rotation-slider').value = obj.rotation;
            } else {
                adjustmentPanel.classList.add('hidden');
            }
            draw();
        }

        function deleteSelectedObject() {
            if (selectedObject) {
                objects = objects.filter(o => o !== selectedObject);
                setSelectedObject(null);
                draw();
            }
        }

        function updateObjectProperty(prop, value) {
            if (!selectedObject) return;
            selectedObject[prop] = parseFloat(value);
            draw();
        }

        function getCanvasPoint(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function hitTest(x, y) {
            for (let i = objects.length - 1; i >= 0; i--) {
                const obj = objects[i];
                let hitRadius = 50; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

                if (obj.type === 'sticker') {
                    hitRadius = (obj.fontSize * obj.scale) / 1.5;
                } else if (obj.type === 'image_sticker') {
                    hitRadius = (Math.max(obj.width, obj.height) * obj.scale) / 2;
                } else if (obj.type === 'text') {
                     hitRadius = (obj.fontSize * obj.scale) * 1.5; // ãƒ†ã‚­ã‚¹ãƒˆã¯å°‘ã—åºƒã‚ã«
                }

                const dx = x - obj.x;
                const dy = y - obj.y;
                if (dx*dx + dy*dy < hitRadius*hitRadius) { 
                    return obj;
                }
            }
            return null;
        }

        // ãƒ¡ã‚¤ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ç”¨ã‚¤ãƒ™ãƒ³ãƒˆ
        canvas.addEventListener('mousedown', startDrag);
        canvas.addEventListener('touchstart', startDrag, { passive: false });
        canvas.addEventListener('mousemove', drag);
        canvas.addEventListener('touchmove', drag, { passive: false });
        canvas.addEventListener('mouseup', endDrag);
        canvas.addEventListener('touchend', endDrag);
        canvas.addEventListener('mouseleave', endDrag);

        function startDrag(e) {
            if (!originalImage && objects.length === 0) return;
            e.preventDefault();
            const p = getCanvasPoint(e);
            const hit = hitTest(p.x, p.y);
            if (hit) {
                if (hit !== selectedObject) {
                    objects = objects.filter(o => o !== hit);
                    objects.push(hit);
                    setSelectedObject(hit);
                }
                isDragging = true;
                dragStart = { x: p.x - hit.x, y: p.y - hit.y };
            } else {
                setSelectedObject(null);
            }
            draw();
        }

        function drag(e) {
            if (!isDragging || !selectedObject) return;
            e.preventDefault();
            const p = getCanvasPoint(e);
            selectedObject.x = p.x - dragStart.x;
            selectedObject.y = p.y - dragStart.y;
            draw();
        }

        function endDrag() { isDragging = false; }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'text-indigo-600', 'border-indigo-500', 'border-b-2');
                btn.classList.add('text-gray-500');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active', 'text-indigo-600', 'border-indigo-500', 'border-b-2');
                    btn.classList.remove('text-gray-500');
                }
            });
        }

        function downloadImage() {
            if (!originalImage) {
                alert("ã¾ãšã¯å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼");
                return;
            }
            const currentSelection = selectedObject;
            selectedObject = null;
            draw();
            const link = document.createElement('a');
            link.download = 'my-purikura-v5.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            selectedObject = currentSelection;
            draw();
        }
        
        draw();
    </script>
</body>
</html>